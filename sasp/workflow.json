{
    "type": "playbook",
    "name": "Playbook - AWS - EC2 - Create Instance",
    "id": "AWS-EC2-Create-Instance",
    "workflow_start": "step--start",
    "workflow_exception": "step--exception",
    "workflow": {
        "step--start": {
            "type": "start",
            "name": "Start",
            "on_completion": "step--create-instance"
        },
        "step--exception": {
            "type": "end",
            "name": "Exception"
        },
        "step--end": {
            "type": "end",
            "name": "End"
        },
        "step--create-instance": {
            "type": "single",
            "name": "Create Instance",
            "commands": [
                {
                    "id": "command--create-instance-0",
                    "type": "http-api",
                    "command": {
                        "method": "POST",
                        "url": "https://ec2.amazonaws.com/",
                        "headers": {
                            "Content-Type": "application/x-www-form-urlencoded; charset=utf-8",
                            "Accept": "application/json"
                        },
                        "body": {
                            "Action": "RunInstances",
                            "ImageId": "ami-0b33d91d",
                            "InstanceType": "t2.micro",
                            "MaxCount": "1",
                            "MinCount": "1",
                            "KeyName": "my-key-pair",
                            "SecurityGroup.1": "my-security-group"
                        }
                    }
                },
                {
                    "id": "command--create-instance-1",
                    "type": "bash",
                    "command": "echo \"{{step--create-instance.response}}\" > /tmp/create-instance-response.json"
                }
            ],
            "on_success": "step--get-instance-id",
            "on_failure": "step--exception"
        },
        "step--get-instance-id": {
            "type": "single",
            "name": "Get Instance ID",
            "commands": [
                {
                    "id": "command--get-instance-id-0",
                    "type": "bash",
                    "command": "cat /tmp/create-instance-response.json | jq -r '.RunInstancesResponse.instancesSet.item[0].instanceId' > /tmp/instance-id.txt"
                }
            ],
            "on_success": "step--decide-instance-state",
            "on_failure": "step--exception"
        },
        "step--decide-instance-state": {
            "type": "if-condition",
            "name": "Decide Instance State",
            "condition": "data.instance-id.0 == 0000",
            "on_true": [
                "step--publish-instance-id"
            ],
            "on_false": [
                "step--publish-failure",
                "step--terminate-instance"
            ],
            "on_completion": "step--end"
        },
        "step--publish-instance-id": {
            "type": "single",
            "name": "Publish Instance ID",
            "commands": [
                {
                    "id": "command--publish-instance-id-0",
                    "type": "bash",
                    "command": "cat /tmp/instance-id.txt | jq -R -s -c '{\"instance-id\": .}' > /tmp/instance-id.json"
                },
                {
                    "id": "command--publish-instance-id-1",
                    "type": "manual",
                    "command": "Publish Instance ID"
                }
            ],
            "on_success": "step--end",
            "on_failure": "step--exception"
        },
        "step--publish-failure": {
            "type": "single",
            "name": "Publish Failure",
            "commands": [
                {
                    "id": "command--publish-failure-0",
                    "type": "bash",
                    "command": "cat /tmp/create-instance-response.json | jq -R -s -c '{\"failure\": .}' > /tmp/failure.json"
                },
                {
                    "id": "command--publish-failure-1",
                    "type": "manual",
                    "command": "Publish Failure"
                }
            ],
            "on_success": "step--end",
            "on_failure": "step--exception"
        },
        "step--terminate-instance": {
            "type": "single",
            "name": "Terminate Instance",
            "commands": [
                {
                    "id": "command--terminate-instance-0",
                    "type": "http-api",
                    "command": {
                        "method": "POST",
                        "url": "https://ec2.amazonaws.com/",
                        "headers": {
                            "Content-Type": "application/x-www-form-urlencoded; charset=utf-8",
                            "Accept": "application/json"
                        },
                        "body": {
                            "Action": "TerminateInstances",
                            "InstanceId.1": "0000"
                        }
                    }
                }
            ],
            "on_success": "step--end",
            "on_failure": "step--exception"
        }
    },
    "playbook_variables": {
        "$$instance-id$$": {
            "type": "string",
            "value": "0000"
        },
        "$$failure$$": {
            "type": "integer",
            "value": "1"
        },
        "$$hash$$": {
            "type": "sha256-hash",
            "value": "016d87d2ec26532d4fdb6d51a79c664919cbc6d8649ed82a67e617d27c17c369"
        }
    }
}